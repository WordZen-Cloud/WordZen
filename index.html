<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WordZen</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&display=swap" rel="stylesheet">
    <style>
        * { -webkit-tap-highlight-color: transparent; outline: none; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: 'Montserrat', sans-serif; position: fixed; }
        
        body { 
            background-size: cover; background-position: center; background-attachment: fixed;
            transition: background-image 0.8s ease-in-out; 
            display: flex; flex-direction: column; align-items: center; 
        }

        /* √úST PANEL */
        .ui-top { position: absolute; top: 45px; width: 92%; display: flex; justify-content: space-between; align-items: flex-start; z-index: 100; }
        .stats-group { display: flex; flex-direction: column; gap: 5px; }
        .stats { background: rgba(0,0,0,0.7); padding: 6px 10px; border-radius: 10px; color: #fff; font-size: 0.65rem; border: 1px solid #39FF14; backdrop-filter: blur(10px); display: flex; align-items: center; gap: 4px; }
        #user-id-display { font-size: 0.5rem; color: rgba(255,255,255,0.8); margin-left: 5px; }

        /* OYUN ALANI VE K√ú√á√úLT√úLM√ú≈û KUTUCUKLAR */
        #game-area { margin-top: 180px; width: 100%; display: flex; flex-direction: column; align-items: center; }
        #word-display { display: flex; gap: 6px; margin-bottom: 30px; flex-wrap: wrap; justify-content: center; padding: 0 15px; }
        .letter-box { width: 38px; height: 48px; background: #fff; color: #000; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 900; text-transform: uppercase; box-shadow: 0 4px 0 #999; }
        #clue-box { width: 88%; padding: 20px; background: rgba(255, 255, 255, 0.05); color: #fff; border-radius: 20px; border: 1px solid rgba(57, 255, 20, 0.5); text-align: center; font-size: 0.9rem; backdrop-filter: blur(15px); }

        /* K√ú√á√úLT√úLM√ú≈û YAN BUTONLAR */
        .side-btns { position: absolute; top: 130px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100; }
        .btn-round { width: 48px; height: 48px; border-radius: 50%; border: none; font-weight: 900; font-size: 0.55rem; cursor: pointer; box-shadow: 0 4px 15px #000; transition: 0.2s; }

        /* MODALLAR */
        #levels-modal, .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; flex-direction: column; padding-top: 60px; backdrop-filter: blur(20px); }
        .levels-header { display: flex; justify-content: space-between; align-items: center; width: 90%; margin: 0 auto 20px; color: #fff; }
        #levels-scroll-area { flex: 1; overflow-y: scroll; width: 100%; padding: 0 5% 50px; display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; -webkit-overflow-scrolling: touch; }

        .level-card { aspect-ratio: 1; background: rgba(255,255,255,0.05); border: 2px solid rgba(57, 255, 20, 0.4); border-radius: 18px; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 1.1rem; font-weight: 900; }
        .level-card.locked { opacity: 0.3; border-color: #444; background: rgba(0,0,0,0.3); color: #777; }
        .level-card.active { border-color: #39FF14; background: rgba(57, 255, 20, 0.2); box-shadow: 0 0 15px rgba(57, 255, 20, 0.4); }

        .close-btn-circle { width: 40px; height: 40px; background: #ff4b2b; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; cursor: pointer; border: none; }

        #hidden-input { position: absolute; top: -100px; opacity: 0; }
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-6px);} 75% {transform: translateX(6px);} }
    </style>
</head>
<body>

    <audio id="music-fon" loop src="fon-muzigi.mp3"></audio>
    <audio id="sound-dogru" src="dogru.mp3"></audio>
    <audio id="sound-yanlis" src="yanlis.mp3"></audio>

    <div class="ui-top">
        <div class="stats-group">
            <div class="stats">B√ñL√úM: <span id="lvl-txt" style="color:#39FF14">1</span></div>
            <div id="user-id-display">ID: Y√ºkleniyor...</div>
        </div>
        
        <div class="stats-group" style="align-items: flex-end;">
            <div style="display:flex; gap:5px;">
                <div class="stats" onclick="openLeaderboard()" style="cursor:pointer; border-color:#ffcc00; padding: 6px 8px;">üèÜ</div>
                <div class="stats" onclick="openLevels()" style="cursor:pointer; border-color:#39FF14">‚ò∞</div>
            </div>
            <div class="stats" style="margin-top:5px; border-color:#39FF14">ü™ô <span id="coin-count">0</span></div>
        </div>
    </div>

    <div class="side-btns">
        <button class="btn-round" style="background:#39FF14; color:#000" onclick="useHint()">ƒ∞PUCU</button>
        <button class="btn-round" style="background:#ff4b2b; color:#fff" onclick="deleteLastLetter()">Sƒ∞L</button>
    </div>

    <div id="game-area">
        <div id="word-display"></div>
        <div id="clue-box">Y√ºkleniyor...</div>
    </div>

    <div id="levels-modal">
        <div class="levels-header"><h2>SEVƒ∞YELER</h2><button class="close-btn-circle" onclick="closeModal('levels-modal')">‚úï</button></div>
        <div id="levels-scroll-area"></div>
    </div>

    <div id="leader-modal" class="modal">
        <div class="levels-header"><h2>Lƒ∞DERLER</h2><button class="close-btn-circle" onclick="closeModal('leader-modal')">‚úï</button></div>
        <div id="leader-list" style="width:90%; margin:0 auto; color:#fff;"></div>
    </div>

    <input type="text" id="hidden-input" autofocus autocomplete="off">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getDatabase, ref, update, get, set } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCFgWqiyOv1UWfehf8zUtu4XqsXTrRdcZc",
            authDomain: "wordzen-2e052.firebaseapp.com",
            databaseURL: "https://wordzen-2e052-default-rtdb.firebaseio.com",
            projectId: "wordzen-2e052",
            storageBucket: "wordzen-2e052.firebasestorage.app",
            messagingSenderId: "309225718128",
            appId: "1:309225718128:web:8a38717b4b6fc8f3a18fb5"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let userId = localStorage.getItem('wordzen_id') || "UZ_" + Math.floor(Math.random()*900000+100000);
        localStorage.setItem('wordzen_id', userId);
        document.getElementById('user-id-display').innerText = "ID: " + userId;

        let coins = 50, currentLevel = 0, maxUnlockedLevel = 0, levelsData = [], hintPrice = 10, bgFreq = 1;
        const fonMuzigi = document.getElementById('music-fon');

        // M√úZƒ∞K KONTROL√ú
        document.addEventListener("visibilitychange", () => {
            if (document.hidden) { fonMuzigi.pause(); } 
            else { fonMuzigi.play().catch(()=>{}); }
        });

        const staticLevels = [
            {a:"ELMA", m:"Kƒ±rmƒ±zƒ± veya ye≈üil renkli, Amasya'sƒ± me≈ühur kƒ±≈ü meyvesi."},
            {a:"Kƒ∞TAP", m:"Okuduk√ßa yeni d√ºnyalar a√ßan, sayfalarƒ± olan bilgi kaynaƒüƒ±."},
            {a:"G√úNE≈û", m:"G√ºnd√ºzleri d√ºnyayƒ± aydƒ±nlatan ve ƒ±sƒ±tan en b√ºy√ºk yƒ±ldƒ±z."},
            {a:"DENƒ∞Z", m:"Kƒ±yƒ±sƒ±nda tatil yapƒ±lan, ucu bucaƒüƒ± olmayan devasa tuzlu su."}
        ];

        async function startApp() {
            const configSnap = await get(ref(db, 'admin/config'));
            if(configSnap.exists()){ hintPrice = configSnap.val().hint_price || 10; bgFreq = configSnap.val().bg_frequency || 1; }
            const userSnap = await get(ref(db, 'users/' + userId));
            if(userSnap.exists()) {
                coins = userSnap.val().coins ?? 50;
                maxUnlockedLevel = userSnap.val().level ?? 0;
                currentLevel = maxUnlockedLevel;
            } else { await set(ref(db, 'users/' + userId), {id: userId, coins: 50, level: 0}); }
            const levelsSnap = await get(ref(db, 'levels'));
            levelsData = levelsSnap.exists() ? [...staticLevels, ...Object.values(levelsSnap.val())] : staticLevels;
            render();
        }

        function render() {
            document.getElementById('coin-count').innerText = coins;
            document.getElementById('lvl-txt').innerText = currentLevel + 1;
            let bgNum = (Math.floor(currentLevel / bgFreq) % 42) + 1;
            document.body.style.backgroundImage = `url('bg${bgNum}.jpg')`;
            const l = levelsData[currentLevel % levelsData.length];
            document.getElementById('clue-box').innerText = l.m;
            const disp = document.getElementById('word-display'); disp.innerHTML = "";
            l.a.split('').forEach(() => {
                const b = document.createElement('div'); b.className = 'letter-box';
                disp.appendChild(b);
            });
            document.getElementById('hidden-input').value = "";
            document.getElementById('hidden-input').focus();
        }

        window.deleteLastLetter = () => {
            const boxes = Array.from(document.querySelectorAll('.letter-box')).reverse();
            for (let b of boxes) { if (b.innerText !== "" && !b.hasAttribute('data-hinted')) { b.innerText = ""; break; } }
            document.getElementById('hidden-input').focus();
        };

        document.getElementById('hidden-input').oninput = (e) => {
            const v = e.target.value.toUpperCase().slice(-1); e.target.value = "";
            const boxes = document.querySelectorAll('.letter-box');
            for(let b of boxes) if(b.innerText === "") { b.innerText = v; checkWin(); break; }
        };

        function checkWin() {
            let typed = "";
            const boxes = document.querySelectorAll('.letter-box');
            boxes.forEach(b => typed += b.innerText);
            const target = levelsData[currentLevel % levelsData.length].a;
            if(typed === target) {
                document.getElementById('sound-dogru').play();
                setTimeout(() => {
                    if (currentLevel === maxUnlockedLevel) {
                        maxUnlockedLevel++; coins += 5;
                        update(ref(db, 'users/'+userId), {level: maxUnlockedLevel, coins: coins});
                    }
                    currentLevel++; render();
                }, 400);
            } else if(typed.length === target.length) {
                document.getElementById('sound-yanlis').play();
                boxes.forEach(b => {
                    if(!b.hasAttribute('data-hinted')) {
                        b.classList.add('shake'); b.style.background = "#ff4b2b";
                        setTimeout(() => { b.innerText=""; b.style.background="#fff"; b.classList.remove('shake'); }, 500);
                    }
                });
            }
        }

        window.useHint = () => {
            const target = levelsData[currentLevel % levelsData.length].a;
            const boxes = document.querySelectorAll('.letter-box');
            const empty = Array.from(boxes).map((b,i)=>b.innerText===""?i:null).filter(x=>x!==null);
            if(coins >= hintPrice && empty.length > 0) {
                const idx = empty[Math.floor(Math.random()*empty.length)];
                boxes[idx].innerText = target[idx];
                boxes[idx].style.color = "#39FF14";
                boxes[idx].setAttribute('data-hinted', 'true');
                coins -= hintPrice; update(ref(db, 'users/'+userId), {coins}); checkWin();
            }
        };

        window.openLevels = () => {
            const modal = document.getElementById('levels-modal');
            const grid = document.getElementById('levels-scroll-area');
            modal.style.display = 'flex';
            grid.innerHTML = "";
            levelsData.forEach((_, i) => {
                const isLocked = i > maxUnlockedLevel;
                const card = document.createElement('div');
                card.className = `level-card ${isLocked ? 'locked' : ''} ${i === currentLevel ? 'active' : ''}`;
                card.innerHTML = isLocked ? "üîí" : (i + 1);
                if(!isLocked) card.onclick = () => { currentLevel = i; closeModal('levels-modal'); render(); };
                grid.appendChild(card);
            });
        };

        window.openLeaderboard = () => {
            const list = document.getElementById('leader-list');
            list.innerHTML = "Y√ºkleniyor...";
            document.getElementById('leader-modal').style.display = 'flex';
            get(ref(db, 'users')).then(s => {
                if(s.exists()){
                    const u = Object.values(s.val()).sort((a,b)=>(b.level||0)-(a.level||0)).slice(0,10);
                    list.innerHTML = "";
                    u.forEach((x,i)=>{ list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222;"><span>#${i+1}</span><span>${(x.id||"---").slice(0,8)}</span><span>Lvl ${x.level||0}</span></div>`; });
                }
            });
        };

        window.closeModal = (id) => { document.getElementById(id).style.display = 'none'; document.getElementById('hidden-input').focus(); };
        document.body.onclick = () => { if(fonMuzigi.paused) fonMuzigi.play(); document.getElementById('hidden-input').focus(); };

        startApp();
    </script>
</body>
</html>